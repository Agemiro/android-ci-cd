name: CI/CD Pipeline-2

on:
  push:
    branches: [workflow-test]
  pull_request:
    branches: [workflow-test]
  # workflow_dispatch:
  #   inputs:
  #     deploy_to_playstore:
  #       description: 'Deploy to Play Store'
  #       required: false
  #       default: 'false'
  #       type: boolean

env:
  NODE_VERSION: '20.x'
  JAVA_VERSION: '17'
  ANDROID_SDK_VERSION: '9477386'
  ANDROID_BUILD_TOOLS: '35.0.0'

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check code formatting
        run: |
          npm run lint -- --format=stylish || true
          echo "Linting completed"

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: |
          npm run test:ci

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          directory: ./coverage
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with detailed output
        run: |
          npm run lint -- --format=json --output-file=eslint-report.json || true
          npm run lint -- --format=stylish || true

      - name: Upload ESLint results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 30

      - name: TypeScript type checking
        run: npm run type-check

      - name: Check for security vulnerabilities
        run: npm audit --audit-level=moderate || true

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, static-analysis]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build Angular application
        run: npm run build:prod

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        working-directory: ./android
        run: chmod +x gradlew

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Build Android APK
        working-directory: ./android
        run: ./gradlew assembleDebug

      - name: Build Android App Bundle (AAB)
        working-directory: ./android
        run: ./gradlew bundleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab
          retention-days: 30

  instrumentation-tests:
    name: Instrumentation Tests
    runs-on: macos-latest
    needs: [build]
    strategy:
      matrix:
        api-level: [29, 33]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # - name: Create Android Emulator
      #   uses: reactivecircus/android-emulator-runner@v2
      #   with:
      #     api-level: ${{ matrix.api-level }}
      #     arch: x86_64
      #     profile: Nexus 6
      #     script: |
      #       npm ci
      #       npm run build:prod
      #       npx cap sync android
      #       cd android
      #       chmod +x gradlew
      #       ./gradlew assembleDebug
      #       ./gradlew connectedAndroidTest

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: instrumentation-test-results-api-${{ matrix.api-level }}
          path: android/app/build/outputs/androidTest-results/**
          retention-days: 30

  functional-tests:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: app-debug-apk
          path: ./artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Appium and dependencies
        run: |
          npm install -g appium
          appium driver install uiautomator2

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # The following block has been removed as per instructions:
      # - name: Create Android Emulator
      #   uses: reactivecircus/android-emulator-runner@v2
      #   with:
      #     api-level: 29
      #     arch: x86_64
      #     profile: Nexus 6
      #     script: |
      #       # Install APK
      #       adb install artifacts/app-debug.apk
      #
      #       # Wait for app to be ready
      #       sleep 5
      #
      #       # Run basic functional tests
      #       # Verify app is installed
      #       adb shell pm list packages | grep com.ionicagemiro.app
      #
      #       # Test app launch
      #       adb shell monkey -p com.ionicagemiro.app -c android.intent.category.LAUNCHER 1
      #       sleep 3
      #
      #       # Check if app is running
      #       adb shell ps | grep com.ionicagemiro.app || echo "App process check completed"
      #
      #       # Take screenshot for verification
      #       adb shell screencap -p /sdcard/screenshot.png
      #       adb pull /sdcard/screenshot.png ./screenshot.png || true

  # The entire Deploy to Play Store job is commented out as per instructions

  # deploy-playstore:
  #   name: Deploy to Play Store
  #   runs-on: ubuntu-latest
  #   needs: [build, instrumentation-tests, functional-tests]
  #   if: |
  #     (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
  #     (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_playstore == 'true')
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download AAB artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: app-release-aab
  #         path: ./artifacts
  #
  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: ${{ env.JAVA_VERSION }}
  #
  #     - name: Decode Google Play Service Account JSON
  #       run: |
  #         echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" > $HOME/google-play-service-account.json
  #
  #     - name: Deploy to Play Store Internal Testing
  #       uses: r0adkll/upload-google-play@v1
  #       with:
  #         serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
  #         packageName: com.ionicagemiro.app
  #         releaseFiles: artifacts/app-release.aab
  #         track: internal
  #         status: completed
  #         inAppUpdatePriority: 2
  #         whatsNewDirectory: ./release-notes
  #         debug: true
  #
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v1
  #       if: startsWith(github.ref, 'refs/tags/')
  #       with:
  #         files: artifacts/app-release.aab
  #         draft: false
  #         prerelease: false
